# Telegraf configuration for Linux power monitoring agent
# Install script substitutes INFLUXDB_SERVER_URL and WRITE_TOKEN_HERE

[global_tags]
  host = "$HOSTNAME"
  role = "agent"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "1s"
  flush_interval = "10s"
  flush_jitter = "2s"
  precision = "1s"
  hostname = ""
  omit_hostname = false

[[outputs.influxdb_v2]]
  urls = ["INFLUXDB_SERVER_URL"]
  token = "WRITE_TOKEN_HERE"
  organization = "homelab"
  bucket = "powermon"
  timeout = "10s"
  ## Optional: retry on write failure
  ## retry_on_http_429 = true

# ── Power metrics via RAPL ────────────────────────────────────────────────────
[[inputs.exec]]
  commands = ["/etc/telegraf/scripts/rapl-power.sh"]
  timeout = "5s"
  data_format = "influx"
  interval = "10s"

# ── NVIDIA GPU power (uncomment if GPU present) ───────────────────────────────
## [[inputs.exec]]
##   commands = [
##     "nvidia-smi --query-gpu=index,name,power.draw --format=csv,noheader,nounits"
##   ]
##   timeout = "5s"
##   data_format = "csv"
##   interval = "10s"
##   [inputs.exec.tagpass]
##     # processed by a separate parsing step

# ── CPU metrics ───────────────────────────────────────────────────────────────
[[inputs.cpu]]
  percpu = false
  totalcpu = true
  collect_cpu_time = false
  report_active = false

# ── Memory metrics ────────────────────────────────────────────────────────────
[[inputs.mem]]

# ── Disk metrics ──────────────────────────────────────────────────────────────
[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

[[inputs.diskio]]

# ── Network metrics ───────────────────────────────────────────────────────────
[[inputs.net]]
  ignore_protocol_stats = true

# ── System metrics ────────────────────────────────────────────────────────────
[[inputs.system]]

[[inputs.processes]]
