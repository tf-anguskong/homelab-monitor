# Telegraf configuration for Windows power monitoring agent
# Install script substitutes INFLUXDB_SERVER_URL and WRITE_TOKEN_HERE

[global_tags]
  host = "$COMPUTERNAME"
  role = "agent"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "1s"
  flush_interval = "10s"
  flush_jitter = "2s"
  precision = "1s"
  hostname = ""
  omit_hostname = false

[[outputs.influxdb_v2]]
  urls = ["INFLUXDB_SERVER_URL"]
  token = "WRITE_TOKEN_HERE"
  organization = "homelab"
  bucket = "powermon"
  timeout = "10s"

# ── Power metrics via WMI / battery ───────────────────────────────────────────
[[inputs.exec]]
  commands = [
    "powershell -NonInteractive -NoProfile -ExecutionPolicy Bypass -File \"C:\\Program Files\\Telegraf\\scripts\\windows-power.ps1\""
  ]
  timeout = "10s"
  data_format = "influx"
  interval = "10s"

# ── UPS metrics via CyberPower PowerPanel Personal / APC ──────────────────────
# Exits silently if no UPS is detected — safe to leave enabled on all machines.
[[inputs.exec]]
  commands = [
    "powershell -NonInteractive -NoProfile -ExecutionPolicy Bypass -File \"C:\\Program Files\\Telegraf\\scripts\\windows-ups.ps1\""
  ]
  timeout = "15s"
  data_format = "influx"
  interval = "60s"

# ── CPU metrics (Windows Performance Counters — more accurate than generic plugin) ──
[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "Processor Information"
    Instances = ["_Total"]
    Counters = [
      "% Processor Time",
      "% Privileged Time",
      "% User Time",
      "% Interrupt Time",
    ]
    Measurement = "win_cpu"
    IncludeTotal = true

  [[inputs.win_perf_counters.object]]
    ObjectName = "Memory"
    Counters = [
      "Available Bytes",
      "Cache Bytes",
      "Committed Bytes",
      "% Committed Bytes In Use",
      "Pages/sec",
    ]
    Instances = ["------"]
    Measurement = "win_mem"

  [[inputs.win_perf_counters.object]]
    ObjectName = "PhysicalDisk"
    Instances = ["_Total"]
    Counters = [
      "Disk Read Bytes/sec",
      "Disk Write Bytes/sec",
      "Current Disk Queue Length",
    ]
    Measurement = "win_diskio"

  [[inputs.win_perf_counters.object]]
    ObjectName = "Network Interface"
    Instances = ["*"]
    Counters = [
      "Bytes Received/sec",
      "Bytes Sent/sec",
      "Packets Received/sec",
      "Packets Sent/sec",
    ]
    Measurement = "win_net"
    IncludeTotal = true

# ── Standard cross-platform metrics ───────────────────────────────────────────
[[inputs.cpu]]
  percpu = false
  totalcpu = true
  collect_cpu_time = false
  report_active = false

[[inputs.mem]]

[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs"]

[[inputs.net]]
  ignore_protocol_stats = true

[[inputs.system]]
